[general]

[globals]

[from-internal]
exten => _8XXXXXXXXXX,1,Dial(PJSIP/${EXTEN}@positel)
exten => _6XX,1,Dial(PJSIP/${EXTEN})
same => n,Hangup()
exten => _7XX,1,Dial(PJSIP/${EXTEN})
same => n,Hangup()

; Вызов queue1001 с внутренних номеров
exten => 1001,1,NoOp(Call queue queue1001)
 same => n,Queue(queue1001)
 same => n,Hangup()

; Вызов queue1002 с внутренних номеров
exten => 1002,1,NoOp(Call queue queue1002)
 same => n,Queue(queue1002)
 same => n,Hangup()

; Добавляем внутренние номера 601, 701, 702 (пример их обычной конфигации)
exten => 601,1,Dial(PJSIP/601,20)
 same => n,Hangup()

exten => 701,1,Dial(PJSIP/701,20)
 same => n,Hangup()

exten => 702,1,Dial(PJSIP/702,20)
 same => n,Hangup()

exten => _2XX,1,Dial(PJSIP/${EXTEN}@serverb)

;exten => 203,1,Dial(PJSIP/${EXTEN})

[orig-sim]
exten => call,1,NoOp(Simulate spam CID)
same => n,Set(CALLERID(num)=+79030495276)
same => n,Goto(from-trunk,s,1)

[from-trunk]
exten=> 601,1,Dial(PJSIP/601)


;[from-trunk]

; --- Путь A: провайдер присылает DID в ${EXTEN} ---
;exten => _X.,1,NoOp(Incoming DID ${EXTEN} from ${CALLERID(num)})
 ;same => n,GotoIf($["${BLACKLIST()}"="1"]?blk)
 ;same => n,AGI(/var/lib/asterisk/agi-bin/check_spam.py,${CALLERID(num)})
 ;same => n,Dial(PJSIP/601,30)
 ;same => n,Hangup()
 ;same => n(blk),NoOp(Blacklisted caller, dropping)
 ;same => n,Hangup()

; --- Путь B: провайдер присылает extension = s ---
;exten => s,1,NoOp(Incoming call (no DID) from ${CALLERID(num)})
; same => n,GotoIf($["${BLACKLIST()}"="1"]?blk)
; same => n,AGI(/var/lib/asterisk/agi-bin/check_spam.py,${CALLERID(num)})
; same => n,Dial(PJSIP/601,30)
; same => n,Hangup()
; same => n(blk),NoOp(Blacklisted caller, dropping)
; same => n,Hangup()


;[from-trunk]
;exten => s,1,NoOp(Incoming call (no DID) from ${CALLERID(num)})
;same => n,GotoIf($["${BLACKLIST()}"="1"]?blk)
;same => n,AGI(/var/lib/asterisk/agi-bin/check_spam.py,${CALLERID(num)})
;same => n,GotoIf($["${SPAM_HIT}"="1"]?blk)
;same => n,Dial(PJSIP/601,30)
;same => n,Hangup()
;same => n(blk),NoOp(Blacklisted caller, dropping)
;same => n,Hangup() .

;[from-trunk-ai]
exten => _X.,1,NoOp(IN: AI operator start) ; лог входящего [web:12]
 same => n,Answer() ; ответим для записи и подсказки [web:12]
 same => n,Set(CALLER_NUM=${CALLERID(num)}) ; сохраним номер [web:12]
 same => n,Playback(custom/brief_prompt-ru) ; "Коротко опишите причину..." [web:12]
 same => n,Set(__REC_BASENAME=${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}-${UNIQUEID}) ; имя файла [web:12]
 same => n,Set(__REC_PATH=/var/spool/asterisk/monitor/${REC_BASENAME}) ; путь [web:12]
 same => n,MixMonitor(${REC_PATH}.wav,b) ; пишем только в мосте/после подсказки можно убрать b [web:12]
 same => n,Wait(8) ; даём 8 секунд на объяснение (можно AGI Record) [web:12]
 same => n,StopMixMonitor() ; завершаем запись [web:12]
 ; шлём HTTP POST на локальное API: вернёт JSON {"queue":"1002","card_url":"https://...","reason":"..."} [web:16][web:10]
 same => n,Set(CURL_OPT(ssl_verifypeer)=0) ; если самоподписанный TLS [web:10]
 same => n,Set(PAYLOAD={ "caller":"${CALLER_NUM}", "file":"${REC_PATH}.wav" })
 same => n,Set(RESP=${CURL(http://127.0.0.1:8090/ai/route,${PAYLOAD})}) ; FastAPI эндпоинт [web:16][web:10]
 same => n,NoOp(AI RESP: ${RESP}) ; лог результата [web:12]
 same => n,Set(TARGETQ=${JSON_DECODE(RESP,queue)}) ; цель очередь [web:16]
 same => n,Set(CARDURL=${JSON_DECODE(RESP,card_url)}) ; url карточки [web:16]
 ; уведомим агента: вариант 1 — http GET в настольное приложение всплывашки [web:10][web:16]
 same => n,Set(IGNORE=${CURL(${CARDURL})}) ; инициируем показ карточки [web:16]
 ; перевод в очередь
 same => n,Queue(${TARGETQ},tT) ; отправляем в целевую очередь [web:12]
 same => n,Hangup() ; завершение [web:12]

