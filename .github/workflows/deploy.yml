name: Deploy Asterisk

on:
  push:
    branches: [ main ]
    paths:
      - 'configs/extensions.conf'

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install asterisklint
        run: pip install asterisklint

      - name: Run dialplan syntax check
        env:
          ALINT_IGNORE: "W_WSH_OBJSET,W_DP_GOTO_CONTEXT_NOEXTEN"
        run: |
          set -e
          asterisklint dialplan-check configs/extensions.conf

  graph:
    needs: lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Graphviz and Python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          pip install graphviz

      - name: Generate dialplan graph PNG
        run: |
          mkdir -p graph
          python << 'EOF'
          from graphviz import Digraph

          dot = Digraph(comment="Asterisk dialplan")
          dot.attr(rankdir="LR", fontsize="10")

          context = None
          with open("configs/extensions.conf", "r") as f:
            for line in f:
              line = line.strip()
              if not line or line.startswith((';', '#')):
                continue
              if line.startswith('[') and line.endswith(']'):
                context = line[1:-1]
                dot.node(context, shape="box", style="filled", fillcolor="lightgrey")
                continue
              if not line.startswith('exten =>') or context is None:
                continue
              try:
                left, app_part = line.split(',', 1)
              except ValueError:
                continue
              parts = left.split()
              if len(parts) < 3:
                continue
              _, _, exten = parts[:3]
              prio, app_rest = app_part.split(',', 1)
              app = app_rest.split('(')[0].strip()
              node_name = f"{context}/{exten}/{prio}"
              label = f"{context}:{exten},{prio}\\n{app}"
              dot.node(node_name, label=label, shape="ellipse")
              dot.edge(context, node_name)
          dot.render("graph/extensions", format="png", cleanup=True)
          EOF
          ls -l graph

  deploy-stage:
    needs: [lint, graph]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Upload extensions.conf to STAGE
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGE_HOST }}
          username: ${{ secrets.STAGE_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: "configs/extensions.conf"
          target: "/etc/asterisk/"

      - name: Upload graph PNG to STAGE
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGE_HOST }}
          username: ${{ secrets.STAGE_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: "graph/extensions.png"
          target: "/etc/asterisk/config/"

      - name: Check reload, rollback if failed (STAGE)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.STAGE_HOST }}
          username: ${{ secrets.STAGE_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "== Prepare new dialplan on STAGE =="

            NEW_TMP="/etc/asterisk/configs/extensions.conf"
            CUR="/etc/asterisk/extensions.conf"
            PREV="/etc/asterisk/extensions.conf.prev"
            BAK="/etc/asterisk/extensions.conf.bak.$(date +%Y%m%d-%H%M%S)"

            if [ ! -f "$NEW_TMP" ]; then
              echo "No new extensions.conf at $NEW_TMP, nothing to do"
              exit 1
            fi

            if [ -f "$CUR" ]; then
              cp -a "$CUR" "$BAK"
            fi

            if [ -f "$CUR" ]; then
              mv "$CUR" "$PREV"
            fi
            mv "$NEW_TMP" "$CUR"
            rmdir /etc/asterisk/configs 2>/dev/null || true

            echo "== Test dialplan reload on STAGE =="
            if asterisk -rx "dialplan reload" >/tmp/ci_dialplan_reload.log 2>&1; then
              echo "Dialplan reload OK, keeping new config"
              rm -f "$PREV"
              exit 0
            else
              echo "Dialplan reload FAILED, rolling back"
              if [ -f "$PREV" ]; then
                mv -f "$PREV" "$CUR"
              fi
              asterisk -rx "dialplan reload" || true
              exit 1
            fi

  deploy-prod:
    needs: deploy-stage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Upload extensions.conf to PROD
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 26852
          source: "configs/extensions.conf"
          target: "/etc/asterisk/"

      - name: Upload graph PNG to PROD
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 26852
          source: "graph/extensions.png"
          target: "/etc/asterisk/config/"

      - name: Check reload, rollback if failed (PROD)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 26852
          script: |
            set -e
            echo "== Prepare new dialplan on PROD =="

            NEW_TMP="/etc/asterisk/configs/extensions.conf"
            CUR="/etc/asterisk/extensions.conf"
            PREV="/etc/asterisk/extensions.conf.prev"
            BAK="/etc/asterisk/extensions.conf.bak.$(date +%Y%m%d-%H%M%S)"

            if [ ! -f "$NEW_TMP" ]; then
              echo "No new extensions.conf at $NEW_TMP, nothing to do"
              exit 1
            fi

            if [ -f "$CUR" ]; then
              cp -a "$CUR" "$BAK"
            fi

            if [ -f "$CUR" ]; then
              mv "$CUR" "$PREV"
            fi
            mv "$NEW_TMP" "$CUR"
            rmdir /etc/asterisk/configs 2>/dev/null || true

            echo "== Test dialplan reload on PROD =="
            if asterisk -rx "dialplan reload" >/tmp/ci_dialplan_reload.log 2>&1; then
              echo "Dialplan reload OK, keeping new config"
              rm -f "$PREV"
              exit 0
            else
              echo "Dialplan reload FAILED, rolling back"
              if [ -f "$PREV" ]; then
                mv -f "$PREV" "$CUR"
              fi
              asterisk -rx "dialplan reload" || true
              exit 1
            fi
